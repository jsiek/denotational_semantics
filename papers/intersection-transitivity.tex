\documentclass{article}
\usepackage{natbib}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathabx}
\usepackage{stmaryrd}
\usepackage{semantic}
%\usepackage{fullpage}
\usepackage{fontspec,unicode-math}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{constraint}[theorem]{Constraint}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}


\title{Transitivity of Subtyping for Intersection Types}
\author{Jeremy G. Siek}

\begin{document}
\maketitle

\newcommand{\TOP}{\ensuremath{\mathtt{U}}}
\newcommand{\dom}[1]{\mathrm{dom}(#1)}
\newcommand{\cod}[1]{\mathrm{cod}(#1)}


\begin{abstract}
  The subtyping relation for intersection type systems traditionally
  employs a transitivity rule (Barendregt et al. 1983), which means
  that the subtyping judgment does not enjoy the subformula property.
  Laurent develops a sequent-style subtyping judgment, without
  transitivity, and proves transitivity via a sequence of six lemmas
  that culminate in cut-elimination (2018). This article presents a
  subtyping judgment, in regular style, that satisfies the subformula
  property, and gives a direct proof of transitivity. Borrowing from
  Laurent's system, the rule for function types is essentially the
  $\beta$-soundness property.  The main lemma required for the
  transitivity proof is one that has been used to prove the inversion
  principle for subtyping of function types (Barendregt et
  al. 2013). The choice of induction principle for the proof of
  transitivity requires some care: we use strong induction on the
  lexicographical ordering of the sum of the depths of the first and
  last type followed by the sum of the sizes of the first and second
  type.
\end{abstract}

\section{Introduction}

Intersection types were invented by Coppo, Dezani-Ciancaglini, and
Salle, as a tool for studying normalization in the lambda
calculus~\citep{Coppo:1979aa}. By varying the subtyping rules and atom
types, researchers have used intersection type systems to model many
different
calculi~\citep{Coppo:1980ab,Coppo:1981aa,Engeler:1981aa,Coppo:1984aa,Honsell:1992aa,Abramsky:1993fk,Plotkin:1993ab,Honsell:1999aa,Rocca:2004aa,Dezani-Ciancaglini:2005aa,Alessi:2006aa}.
Perhaps the best-known of them is the BCD intersection type system of
\citet{Barendregt:1983aa}. For this article we focus on the BCD
system, following the presentation of \citet{Barendregt:2013aa}.  We
conjecture that our results apply to other intersection type systems.

The BCD intersection type systems extends the simply-typed lambda
calculus with the addition of intersection types, written $A ∩ B$, a
top type $\TOP$, and an infinite collection of type
constants. Figure~\ref{fig:types} defines the grammar of types.

\begin{figure}[tbp]
  \[
  \begin{array}{lclr}
    \alpha,\beta & ::= & \TOP \mid c_0 \mid c_1 \mid c_2 \mid \cdots & \text{atoms}\\
    A,B,C,D & ::= & \alpha \mid A → B \mid A ∩ B & \text{types}
  \end{array}
  \]
  \caption{Intersection Types}
  \label{fig:types}
\end{figure}

The BCD intersection type system includes a subsumption rule which
states that a term $M$ in environment $\Gamma$ can be given type $B$
if it has type $A$ and $A$ is a subtype of $B$, written $A ≤ B$.
\[
\inference{\Gamma \vdash M : A & A ≤ B}
          {\Gamma \vdash M : B}
\]
Figure~\ref{fig:BCD-subtyping} reviews the BCD rules for subtyping.
Note that in the (trans) rule, the type $B$ that appears in the
premises does not appear in the conclusion. Thus, the BCD subtyping
judgment does not enjoy the subformula property.  For other systems,
it is straightforward to remove the (trans) rule, modify the other
rules, and then then prove transitivity~\citep{Muehlboeck:2018aa}.
Unfortunately, the ${→}{∩}$ rule significantly complicates the
situation for the BCD system.

\begin{figure}[tbp]
  \fbox{$A ≤ B$} \\[1ex]
  
  \centering
  \begin{tabular}{p{1in}l}
    (refl)  & $A ≤ A$ \\[3ex]
    (incl$_L$) & $A ∩ B ≤ A$ \\[3ex]
    (incl$_R$) & $A ∩ B ≤ B$ \\[3ex]
    (glb) & $\inference{C ≤ A & C ≤ B}{C ≤ A ∩ B}$ \\[3ex]
    (trans) & $\inference{A ≤ B & B ≤ C}{A ≤ C}$ \\[3ex]
    ($\TOP_{\mathrm{top}}$) & $A ≤ \TOP$ \\[3ex]
    ($\TOP{→}$) & $\TOP ≤ A → \TOP$ \\[3ex]
    (${→}{∩}$) & $(A → B) ∩ (A → C) ≤ A → (B ∩ C)$ \\[3ex]
    ($→$) & $\inference{A' ≤ A & B ≤ B'}{A → B ≤ A' → B'}$
  \end{tabular}
  \caption{The Subtyping Judgment of Barendregt, Coppo, and Dezani (BCD).}
  \label{fig:BCD-subtyping}
\end{figure}

The subformula property is a useful one. For example, the author is
using intersection types to create a denotational semantics for the
ISWIM language, which includes constants and primitive
operations~\citep{Landin:1966la,G.-D.-Plotkin:1975on,Felleisen:2009aa}.
It seems that doing so requires placing extra conditions on types and
that is much easier when subtyping satisfies the subformula property.

%\citet{Laurent:2012aa}

\citet{Laurent:2018aa} introduces the ISC sequent-style system,
written $\Gamma \vdash B$, where $\Gamma$ is a sequence of types
$A_1,\ldots,A_n$. The intuition is that $A_1,\ldots,A_n \vdash B$
corresponds to $A_1 ∩ \cdots ∩ A_n ≤ B$. The ISC system satisfies the
subformula property and is equivalent to the BCD system. To prove
this, Laurent establishes six lemmas that culminate in
cut-elimination, from which transitivity follows dirctly.

This article presents a more direct route to the subformula property
and transitivity. We present a subtyping relation $A <: B$ and
directly prove transitivity, without using an auxilliary sequent-style
system. Nevertheless, the intuitions are based on those of
Laurent. The key to $A <: B$ is a rule for function types based on the
$\beta$-soundness property~\citep{Barendregt:2013aa}, just as in ISC.


ROAD MAP


%$λ^{\mathrm{BCD}}_∩$

\section{Intersection Subtyping, with Subformula}

Our new subtyping judgment relies on several auxilliary notions, which
we define in Figure~\ref{fig:aux}. These include the $\dom{}$ and
$\cod{}$ functions. For function types they simply return the domain
and codomain, respectively. For intersections, $\dom{A ∩ B}$ is the
intersection of the domain of $A$ and $B$. Similarly for $\cod{}$.
Both $\dom{}$ and $\cod{}$ are undefined on atoms.



\begin{figure}[tbp]

  \fbox{$\dom{A}, \cod{A}$}
  \begin{align*}
  \dom{A → B} &= A \\
  \dom{A ∩ B} &= \dom{A} ∩ \dom {B} \\
  \\
  \cod{A → B} &= B \\
  \cod{A ∩ B} &= \cod{A} ∩ \cod {B}
  \end{align*}

  \fbox{$\mathsf{top}(A)$}
  \begin{gather*}
    \mathsf{top}(\TOP)
    \quad
    \inference{\mathsf{top}(B)}{\mathsf{top}(A → B)}
    \quad
    \inference{\mathsf{top}(A) & \mathsf{top}(B)}{\mathsf{top}(A ∩ B)}
  \end{gather*}

  \fbox{$A ∈ B$}
  \begin{gather*}
    \inference{}{\alpha ∈ \alpha}  \quad
    \inference{}{A → B ∈ A → B} \\[3ex]
    \inference{A ∈ B}{A ∈ B ∩ C} \quad
    \inference{A ∈ C}{A ∈ B ∩ C}
  \end{gather*}

  \fbox{$A ⊆ B$}
  \[
     A ⊆ B = ∀ C.\, C ∈ A \text{ implies } C ∈ B
  \]

  \fbox{$\mathsf{topInCod}(D)$}
  \[
  \mathsf{topInCod}(D) =
     \exists A B.\, A → B ∈ D \text{ and } \mathsf{top}(B)  
  \]

  \caption{Auxiliary definitions}
  \label{fig:aux}
\end{figure}


\begin{figure}[tbp]
  \fbox{$A <: B$} \\[1ex]
  
  \centering
  \begin{tabular}{p{1in}l}
    (refl$_α$) & $\inference{}{α <: α}$ \\[3ex]
    (lb$_L$) & $\inference{A <: C}{A ∩ B <: C}$ \\[3ex]
    (lb$_R$) & $\inference{B <: C}{A ∩ B <: C}$ \\[3ex]
    (glb) & $\inference{C ≤ A & C ≤ B}{C ≤ A ∩ B}$ \\[3ex]
    ($\TOP_{\mathrm{top}}$) & $\inference{}{A <: \TOP}$ \\[3ex]
    ($\TOP{→}'$) & $\inference{}{C <: A → B}\;\mathsf{top}(B)$ \\[3ex]
    ($→'$) &$\inference{A <: \dom{D} & \cod{D} <: B }{C <: A → B}\begin{array}{l} \neg\, \mathsf{top}(B) \\ \neg \, \mathsf{topInCod}(D) \\ D ⊆ C \end{array}$
  \end{tabular}
  \caption{The New Subtyping Judgment}
  \label{fig:new-subtyping}
\end{figure}


\section{Transitivity}


\begin{definition}[factors]
  We say $A → B$ \emph{factors} $C$
  if there exists some type $C'$ such that
  $C' ⊆ C$, $\neg\,\mathsf{topInCod}(C')$, $A <: \dom{C'}$, and $\cod{C'} <: B$.
\end{definition}

\begin{lemma}\label{lem:sub-fun-inv}
  If $\neg\,\mathsf{top}(B)$,
  $D <: C$, and
  $A → B ∈ C$, then
  $A → B$ factors $D$.
\end{lemma}


\begin{lemma}\label{lem:sub-inv-trans}
  If
  \begin{itemize}
  \item $\neg\, \mathsf{topInCod}(D)$,
  \item for any $A,B$, if $\neg\,\mathsf{top}(B)$ and $A → B ∈ D$,
    then $A → B$ factors $C$,
  \end{itemize}
  then $\dom{D} → \cod{D}$ factors $C$.
\end{lemma}

\begin{align*}
  \mathsf{size}(\alpha) &= 0 \\
  \mathsf{size}(A → B) &= 1 + \mathsf{size}(A) + \mathsf{size}(B) \\
  \mathsf{size}(A ∩ B) &= 1 + \mathsf{size}(A) + \mathsf{size}(B)
\end{align*}

\begin{align*}
  \mathsf{depth}(\alpha) &= 0 \\
  \mathsf{depth}(A → B) &= 1 + \max(\mathsf{depth}(A), \mathsf{depth}(B)) \\
  \mathsf{depth}(A ∩ B) &= \max(\mathsf{depth}(A), \mathsf{depth}(B))
\end{align*}

\begin{theorem}[Transitivity of $<:$]\label{lem:sub-trans}
    If $A <: B$ and $B <: C$, then $A <: C$.
\end{theorem}


\begin{theorem}[Equivalence of the subtyping relations]\ \\
  $A <: B$ if and only if $A ≤ B$.
\end{theorem}

\clearpage
\pagebreak

\bibliographystyle{abbrvnat}
\bibliography{all}

\end{document}

% LocalWords:  dom subtyping Barendregt et al subformula sequent aa
% LocalWords:  BCD lclr refl glb topInCod Coppo Dezani Ciancaglini fk
% LocalWords:  Salle Engeler Honsell Abramsky Plotkin Rocca Alessi
% LocalWords:  subsumption subtype denotational ISWIM Landin
% LocalWords:  Felleisen
